<html>
<head>
    <title>UnitAI Execution Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
<style>
    .node {
        cursor: pointer;
    }

    textarea {
        min-width: 100%;
        min-height: 500px;
        max-height: 600px;
        font-family: monospace;
        font-size: medium;
    }

    pre {
        font-family: monospace;
        max-width: 70%;
    }

    h2 {
        margin-top: 20px;
    }

    .tree-img {
        max-width: 100%;
    }
</style>
<script>
    const root = __JSON_TREE__;

    // Explore tree from root and create a tree hashmap by node.id
    const treeMap = {};
    const stack = [root];
    while (stack.length > 0) {
        const node = stack.pop();
        treeMap[node.count] = node;
        if (node.children) {
            node.children.forEach((child) => {
                stack.push(child);
            });
        }
    }
    console.log(treeMap)

    document.addEventListener('DOMContentLoaded', () => {
        const lis = [...document.getElementsByClassName('node')];
        lis.forEach((li) => {
            li.addEventListener('click', (event) => {
                const id = event.target.id;
                // Unselect others
                lis.forEach((li) => li.classList.remove('bg-info'));
                // Highlight the first span child of event target:
                event.target.classList.add('bg-info');

                const node = treeMap[id];
                console.log(node);
                let allErrors = '';
                if (node.errors) {
                    for (let i = 0; i < node.errors.length; i++) {
                        const error = node.errors[i];
                        allErrors += `######## ERROR ${i} ########\n\n${error}\n\n`;
                    }
                }
                const mainDiv = document.getElementById('main');
                mainDiv.innerHTML = `
                Count: ${node.count}<br/>
                Score: ${node.score}<br/>
                Passed Assertions: ${node.passed_assertions} / ${node.total_assertions}<br/>
                Temperature: ${node.temperature}<br/><br/>
                <h2>AI Prompt:</h2>
                <textarea>${node.prompt}</textarea>
                <h2>AI Output:</h2>
                <textarea>${node.ai_output}</textarea>
                <h2>Errors:</h2>
                <pre>${allErrors}</pre>
            `
                const entitiesDiv = document.getElementById('entities');
                entitiesDiv.innerHTML = '';
                for (const [entityName, impl] of Object.entries(node.impls)) {
                    entitiesDiv.innerHTML += `
                    <div>
                        <h2>Entity: ${entityName}</h2>
                        <p>Implementation:</p>
                        <textarea>${impl}</textarea>
                    </div>
                `
                }
            });

        });
    });
</script>
<div class="container-fluid">
    <h1>UnittestAI Execution Report</h1>
    <img src="__TREE_IMG__" class="tree-img"/>
    <br/><br/>
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <p class="card-text">
                        __TREE__
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div id="main">
                Click on a node to see details
            </div>
            <div id="entities"></div>
        </div>
    </div>
</div>
</body>
</html>